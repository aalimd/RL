name: Deploy to Hostinger

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: ðŸŽ‰ Deploy (Zip Strategy)
    runs-on: ubuntu-latest
    steps:
      - name: ðŸšš Get latest code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, intl, zip, pdo_mysql

      - name: ðŸ“¦ Install Dependencies
        working-directory: ./backend
        run: composer install --no-dev --optimize-autoloader

      - name: ðŸ“¦ Create Deployment Package
        run: |
          mkdir deploy_package
          cd backend
          # Define unique names
          ZIP_NAME="release_${{ github.sha }}.zip"
          SCRIPT_NAME="unzip_${{ github.sha }}.php"
          
          # Zip the contents
          zip -r "../deploy_package/$ZIP_NAME" . -x "*.git*" "*.github*" "node_modules/*" "storage/*.key" "storage/logs/*" ".env" "phpunit.xml" ".DS_Store" "tests/*"
          
          # Create Smart & SAFE Extraction Script
          echo "<?php
          // Increase limits
          ini_set('memory_limit', '512M');
          ini_set('max_execution_time', 300);

          header('Content-Type: text/plain'); 
          echo 'ðŸš€ Starting Safe Deployment...'.PHP_EOL;

          \$zipFile = '$ZIP_NAME';
          \$extractPath = __DIR__ . '/backend';
          \$lockFile = 'deploy.lock';

          try {
              // 1. INTEGRITY CHECK (Verify Zip before touching anything)
              \$zip = new ZipArchive;
              if (\$zip->open(\$zipFile) !== TRUE) {
                  throw new Exception('âŒ Invalid or corrupted ZIP file. Aborting.');
              }
              echo 'âœ… Integrity Check Passed.'.PHP_EOL;

              // 2. PERMISSION CHECK (Non-destructive write test)
              \$testFile = \$extractPath . '/write_test.tmp';
              if (@file_put_contents(\$testFile, 'test') === false) {
                  throw new Exception('âŒ Write permission denied. Cannot write to backend folder.');
              }
              @unlink(\$testFile);
              echo 'âœ… Write Permission Verified.'.PHP_EOL;

              // 3. EXTRACTION
              if (!file_exists(\$extractPath)) {
                  mkdir(\$extractPath, 0755, true);
              }
              
              if (!\$zip->extractTo(\$extractPath)) {
                  throw new Exception('âŒ Extraction failed during process.');
              }
              \$zip->close();
              echo 'âœ… Files Extracted Successfully.'.PHP_EOL;

              // 3.5 FIX PERMISSIONS
              \$dirsToFix = [
                  '/storage',
                  '/storage/app',
                  '/storage/framework',
                  '/storage/framework/cache',
                  '/storage/framework/sessions',
                  '/storage/framework/views',
                  '/storage/logs',
                  '/bootstrap/cache'
              ];
              foreach (\$dirsToFix as \$subdir) {
                  \$path = \$extractPath . \$subdir;
                  if (file_exists(\$path)) {
                      @chmod(\$path, 0775); // Try 775 first
                      if (!is_writable(\$path)) {
                          @chmod(\$path, 0777); // Fallback to 777
                      }
                  }
              }
              echo 'âœ… Permissions Fixed.'.PHP_EOL;

              // 4. POST-DEPLOYMENT OPTIMIZATION
              if (file_exists(\$extractPath . '/vendor/autoload.php')) {
                  require \$extractPath . '/vendor/autoload.php';
                  \$app = require_once \$extractPath . '/bootstrap/app.php';
                  \$kernel = \$app->make(Illuminate\Contracts\Http\Kernel::class);
                  \$kernel->bootstrap();

                  echo 'âœ… Laravel Bootstrapped.'.PHP_EOL;

                  // Force maintenance mode off if stuck? No, just standard routine.
                  Illuminate\Support\Facades\Artisan::call('migrate', ['--force' => true]);
                  echo 'âœ… Database Migrated.'.PHP_EOL;

                  // Encrypt sensitive settings (Safe to run multiple times)
                  Illuminate\Support\Facades\Artisan::call('settings:encrypt');
                  echo 'âœ… Settings Encrypted.'.PHP_EOL;

                  Illuminate\Support\Facades\Artisan::call('view:clear');
                  Illuminate\Support\Facades\Artisan::call('cache:clear');
                  Illuminate\Support\Facades\Artisan::call('config:clear');
                  Illuminate\Support\Facades\Artisan::call('route:clear');
                  echo 'âœ… Cache Cleared.'.PHP_EOL;
              }

          } catch (Exception \$e) {
              http_response_code(500);
              echo 'ðŸ”¥ CRITICAL ERROR: ' . \$e->getMessage() . PHP_EOL;
              exit(1);
          } finally {
              // 5. CLEANUP (Always clean up zip and script)
              if (file_exists(\$zipFile)) @unlink(\$zipFile);
              // Self-destruct script
              @unlink(__FILE__);
              echo 'ðŸ§¹ Cleanup Complete.';
          }
          ?>" > "../deploy_package/$SCRIPT_NAME"

      - name: ðŸ“‚ Sync files (Upload Zip)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: sftp
          port: 65002
          timeout: 600000
          security: loose
          local-dir: ./deploy_package/
          server-dir: ./

      - name: ðŸš€ Trigger Unzip on Server
        run: curl -s "${{ secrets.APP_URL }}/unzip_${{ github.sha }}.php"
        continue-on-error: true
